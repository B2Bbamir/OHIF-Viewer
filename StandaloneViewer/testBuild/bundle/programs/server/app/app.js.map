{"version":3,"sources":["meteor://ðŸ’»app/server/collections.js","meteor://ðŸ’»app/routes.js"],"names":["Meteor","module","watch","require","v","RequestStudies","Collection","remove","testDataFiles","forEach","file","indexOf","jsonData","Assets","getText","data","JSON","parse","insert","Router","OHIF","icrXnatRoiSession","sessionMap","productionMode","isClient","log","info","disconnect","url","window","location","href","origin","urlExtention","replace","split","console","viewerRoot","rootUrl","Session","set","configure","loadingTemplate","onBeforeAction","route","onRun","next","params","subjectId","projectId","experimentId","experimentLabel","parentProjectId","query","error","RoiStateManagement","checkAndSetPermissions","jsonRequestUrl","get","getJson","then","json","warn","updateSessionMap","jsonString","stringify","RegExp","catch","subjectExperimentListUrl","experimentList","ResultSet","Result","results","i","length","experimentIdI","ID","experimentJSONFetchUrl","Promise","all","jsonFiles","studyList","transactionId","studies","experimentJsonI","studiesI","label","studyDescription","action","render","id","idUrl","oReq","XMLHttpRequest","addEventListener","responseText","open","setRequestHeader","send","isServer","where","findOne","response","setHeader","write","end","seriesList","j","seriesInstanceUid","resolve","reject","xhr","onload","status","onerror","responseType"],"mappings":"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","file":"/app.js","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\n// Create a Collection to store data\nRequestStudies = new Meteor.Collection('requestStudies');\n\n// Remove all previous data\nRequestStudies.remove({});\n\nconst testDataFiles = [\n    'sample.json',\n    'testDICOMs.json',\n    'CRStudy.json',\n    'CTStudy.json',\n    'DXStudy.json',\n    'MGStudy.json',\n    'MRStudy.json',\n    'PTCTStudy.json',\n    'RFStudy.json'\n];\n\ntestDataFiles.forEach(file => {\n    if (file.indexOf('.json') === -1) {\n        return;\n    }\n\n    // Read JSON files and save the content in the database\n    const jsonData = Assets.getText(`testData/${file}`);\n    const data = JSON.parse(jsonData);\n\n    RequestStudies.insert(data);\n});\n","import { Meteor } from 'meteor/meteor';\nimport { Router } from 'meteor/clinical:router';\nimport { OHIF } from 'meteor/ohif:core';\nimport { icrXnatRoiSession, sessionMap } from 'meteor/icr:xnat-roi-namespace';\n\nconst productionMode = true;\n\nif (Meteor.isClient && productionMode) {\n  // XNAT deployment mode.\n  // Disconnect from the Meteor Server since we don't need it\n  OHIF.log.info('Disconnecting from the Meteor server');\n  Meteor.disconnect();\n\n  const url = window.location.href;\n\n  const origin = window.location.origin;\n  const urlExtention = url.replace(origin, '').split('VIEWER')[0].replace(/\\//g, '');\n\n  console.log(urlExtention);\n\n  let viewerRoot;\n  let rootUrl;\n\n  if (urlExtention) {\n    viewerRoot = `/${urlExtention}/VIEWER`;\n    rootUrl = `${origin}/${urlExtention}`;\n  } else {\n    viewerRoot = `/VIEWER`;\n    rootUrl = origin;\n  }\n\n  Session.set('rootUrl', rootUrl);\n  Session.set('viewerRoot', viewerRoot);\n\n  console.log(`origin: ${origin}`);\n  console.log(`urlExtention ${urlExtention}`);\n  console.log(`rootUrl: ${rootUrl}`);\n  console.log(`viewerRoot\" ${viewerRoot}`);\n\n  Router.configure({\n      loadingTemplate: 'loading'\n  });\n\n  Router.onBeforeAction('loading');\n\n  // JPETTS -- route based on XNAT root\n  Router.route(`${viewerRoot}`, {\n      onRun: function() {\n          console.log('onRun');\n\n          const next = this.next;\n\n          console.log(this.params);\n\n          // Query params:\n          //\n          // Single Session:\n          //   projectId, subjectId, experimentId, experimentLabel\n          //\n          // Single Session in shared project:\n          //   projectId, subjectId, experimentId, experimentLabel, parentProjectId\n          //\n          // Subject (WIP):\n          //   projectId, subjectId\n\n          let subjectId;\n          let projectId;\n          let experimentId;\n          let experimentLabel;\n          let parentProjectId;\n\n          if (this.params.query) {\n            const query = this.params.query;\n\n            experimentLabel = query.experimentLabel;\n            parentProjectId = query.parentProjectId;\n            subjectId = query.subjectId;\n            projectId = query.projectId;\n            experimentId = query.experimentId;\n          } else {\n            console.error('insufficient query parameters.');\n          }\n\n          if (parentProjectId) {\n            console.log(`This experiment is shared view of ${experimentId} from ${parentProjectId}`);\n          }\n\n          if (experimentId) {\n            // Single Session\n            //\n            icrXnatRoiSession.set('sourceProjectId', parentProjectId ? parentProjectId : projectId);\n            //icrXnatRoiSession.set('experimentId', experimentId);\n            //icrXnatRoiSession.set('experimentLabel', experimentLabel);\n            icrXnatRoiSession.set('subjectId', subjectId);\n            icrXnatRoiSession.set('projectId', projectId);\n            icrXnatRoiSession.set('parentProjectId', parentProjectId);\n\n            OHIF.RoiStateManagement.checkAndSetPermissions();\n\n            // Build JSON GET url.\n            const jsonRequestUrl = `${Session.get('rootUrl')}/xapi/viewer/projects/${projectId}/experiments/${experimentId}`;\n\n            getJson(jsonRequestUrl).then(json => {\n              // Parse the response content\n              // https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText\n              if (!json) {\n                  OHIF.log.warn('Response was undefined');\n                  return;\n              }\n\n              updateSessionMap(json, experimentId, experimentLabel);\n\n              let jsonString = JSON.stringify(json);\n\n              if (parentProjectId) {\n                console.log(`replacing ${parentProjectId} with ${projectId}`);\n                jsonString = jsonString.replace( new RegExp( parentProjectId, 'g' ), projectId );\n              }\n\n              this.data = JSON.parse(jsonString);\n\n              next();\n            }).catch(error => {\n              console.log(error);\n              OHIF.log.warn('An error occurred while retrieving the JSON data');\n              next();\n            });\n          } else {\n            // Whole Subject.\n            //\n\n            icrXnatRoiSession.set('sourceProjectId', projectId);\n            icrXnatRoiSession.set('projectId', projectId);\n            icrXnatRoiSession.set('subjectId', subjectId);\n\n\n            const subjectExperimentListUrl = `${Session.get('rootUrl')}/data/archive/projects/${projectId}/subjects/${subjectId}/experiments?format=json`;\n\n\n            OHIF.RoiStateManagement.checkAndSetPermissions();\n\n\n\n            //\n            // TODO:\n            // ROICollection IO restructure.\n            // SeriesInstanceUID -> ExperimentId + projectId map.\n            // Update IO to deal with the new Schema.\n\n            getJson(subjectExperimentListUrl).then(json => {\n              // TODO -> Fetch each json.\n              // Promise.all and combine JSON.\n              // Load up viewer.\n              console.log(json);\n\n              const experimentList = json.ResultSet.Result;\n              const results = [];\n\n              for (let i = 0; i < experimentList.length; i++) {\n                const experimentIdI = experimentList[i].ID;\n\n                const experimentJSONFetchUrl = `${Session.get('rootUrl')}/xapi/viewer/projects/${projectId}/experiments/${experimentIdI}`;\n\n                results[i] = getJson(experimentJSONFetchUrl);\n              }\n\n              Promise.all(results).then((jsonFiles) => {\n                console.log(jsonFiles);\n\n                const studyList = {\n                  transactionId: subjectId,\n                  studies: []\n                };\n\n                for (let i = 0; i < jsonFiles.length; i++) {\n                  const experimentJsonI = jsonFiles[i];\n                  const studiesI = experimentJsonI.studies;\n\n                  updateSessionMap(experimentJsonI, experimentList[i].ID, experimentList[i].label);\n\n                  console.log('Session Map:')\n                  console.log(sessionMap);\n\n                  // TODO -> clean this\n                  studiesI[0].studyDescription = experimentList[i].label || experimentList[i].ID;\n\n                  console.log(`Studies[${i}]`);\n\n                  console.log(studiesI);\n\n                  studyList.studies = [...studyList.studies, ...studiesI];\n                }\n\n                console.log(studyList);\n\n                this.data = studyList;\n\n                console.log(this);\n                console.log(this.data);\n\n                next();\n              });\n\n            });\n\n          }\n      },\n      action() {\n        console.log('Loading up viewer with json!');\n          // Render the Viewer with this data\n          this.render('standaloneViewer', {\n              data: () => this.data\n          });\n      }\n  });\n} else {\n    // Local dev mode.\n    if (Meteor.isClient) {\n      // Disconnect from the Meteor Server since we don't need it\n      OHIF.log.info('Disconnecting from the Meteor server');\n      Meteor.disconnect();\n\n      Router.configure({\n          loadingTemplate: 'loading'\n      });\n\n      Router.onBeforeAction('loading');\n\n      Router.route('/:id?', {\n          onRun: function() {\n              console.warn('onRun');\n              // Retrieve the query from the URL the user has entered\n              const query = this.params.query;\n              const id = this.params.id;\n\n              if (!id && !query.url) {\n                  console.log('No URL was specified. Use ?url=${yourURL}');\n                  return;\n              }\n\n              const next = this.next;\n              const idUrl = `/api/${id}`;\n              const url = query.url || idUrl;\n\n              // Define a request to the server to retrieve the study data\n              // as JSON, given a URL that was in the Route\n              const oReq = new XMLHttpRequest();\n\n              // Add event listeners for request failure\n              oReq.addEventListener('error', () => {\n                  OHIF.log.warn('An error occurred while retrieving the JSON data');\n                  next();\n              });\n\n              // When the JSON has been returned, parse it into a JavaScript Object\n              // and render the OHIF Viewer with this data\n              oReq.addEventListener('load', () => {\n                  // Parse the response content\n                  // https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText\n                  if (!oReq.responseText) {\n                      OHIF.log.warn('Response was undefined');\n                      return;\n                  }\n\n                  OHIF.log.info(JSON.stringify(oReq.responseText, null, 2));\n                  this.data = JSON.parse(oReq.responseText);\n\n                  next();\n              });\n\n              // Open the Request to the server for the JSON data\n              // In this case we have a server-side route called /api/\n              // which responds to GET requests with the study data\n              OHIF.log.info(`Sending Request to: ${url}`);\n              oReq.open('GET', url);\n              oReq.setRequestHeader('Accept', 'application/json')\n\n              // Fire the request to the server\n              oReq.send();\n          },\n          action() {\n              // Render the Viewer with this data\n              this.render('standaloneViewer', {\n                  data: () => this.data\n              });\n          }\n      });\n    }\n\n    // This is ONLY for demo purposes.\n    if (Meteor.isServer) {\n      // You can test this with:\n      // curl -v -H \"Content-Type: application/json\" -X GET 'http://localhost:3000/getData/testId'\n      //\n      // Or by going to:\n      // http://localhost:3000/api/testId\n\n      Router.route('/api/:id', { where: 'server' }).get(function() {\n        // \"this\" is the RouteController instance.\n        // \"this.response\" is the Connect response object\n        // \"this.request\" is the Connect request object\n        const id = this.params.id;\n\n        // Find the relevant study data from the Collection given the ID\n        const data = RequestStudies.findOne({ transactionId: id });\n\n        // Set the response headers to return JSON to any server\n        this.response.setHeader('Content-Type', 'application/json');\n        this.response.setHeader('Access-Control-Allow-Origin', '*');\n        this.response.setHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');\n\n        // Change the response text depending on the available study data\n        if (!data) {\n          this.response.write('No Data Found');\n        } else {\n          // Stringify the JavaScript object to JSON for the response\n          this.response.write(JSON.stringify(data));\n        }\n\n        // Finalize the response\n        this.response.end();\n      });\n    }\n}\n\n\nfunction updateSessionMap(json, experimentId, experimentLabel) {\n  console.log(json);\n\n  const studies = json.studies;\n\n  for (let i = 0; i < studies.length; i++) {\n    const seriesList = studies[i].seriesList;\n\n    console.log(`seriesList ${i}`);\n\n    for (let j = 0; j < seriesList.length; j++) {\n      console.log(`series [${i}, ${j}]`);\n\n      sessionMap[seriesList[j].seriesInstanceUid] = {\n        experimentId,\n        experimentLabel\n      };\n    }\n  }\n\n  console.log(`end of updateSessionMap:`);\n  console.log(sessionMap);\n}\n\n\nfunction getJson(url) {\n  return new Promise((resolve, reject) => {\n    // Define a request to the server to retrieve the session data as JSON.\n    const xhr = new XMLHttpRequest();\n\n    xhr.onload = () => {\n      console.log(`GET ${url}... ${xhr.status}`);\n\n      resolve(xhr.response);\n    };\n\n    xhr.onerror = () => {\n      reject(xhr.responseText);\n    };\n\n    xhr.open(\"GET\", url);\n    xhr.responseType = \"json\";\n    xhr.send();\n  });\n}\n"]}